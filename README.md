## Overview
This project involves setting up a home lab environment using VirtualBox to simulate a small Active Directory infrastructure with two Windows 10 machines, a Kali Linux machine for penetration testing, and a Splunk machine for telemetry and log analysis. The environment was configured to simulate security attacks on an Active Directory domain, collect telemetry data, and analyze potential vulnerabilities.

## Objective

The lab aims to provide a hands-on experience in setting up a virtualized environment for cybersecurity testing and exploration. Participants will create and configure multiple virtual machines (VMs) running Windows 10, Kali Linux, Windows Server, and Ubuntu Server. The lab focuses on teaching essential skills such as network configuration, security tool installation (e.g., Splunk, Sysmon), endpoint monitoring, and conducting security tests (including brute force attacks with Crowbar). Additional objectives include joining Windows machines to an Active Directory domain, enabling Remote Desktop, and automating tasks using PowerShell scripting. Overall, the lab offers practical exposure to cybersecurity concepts, tools, and techniques in a controlled, safe environment.

## Tools:
- Oracle VM VirtualBox Manager: For creating and managing virtual machines (VMs).
- Active Directory: For centralized domain management and user authentication.
- PowerShell: For scripting and automation of tasks.
- Splunk Server: For log analysis and monitoring, and SIEM to collect and analyze system logs.
- Crowbar: For brute force attacks.
- Atomic Red Team: For simulating adversary tactics via PowerShell.
- Sysmon: For monitoring and logging system activity on Windows.
- Splunk Universal Forwarder: For collecting and forwarding log data to Splunk.

## Step-by-Step Guide:

## Phase 1: Environment Install and Configuration

***1. Draw a diagram of the environment using a tool such as <a href="https://app.diagrams.net/">draw.io</a>***

A lab diagram helps organize and plan the setup, showing how different systems, tools, and network elements are connected. This aids in troubleshooting, understanding workflows, and ensuring everything is properly configured for experiments or security testing.

![AD Lab Diagram](https://github.com/user-attachments/assets/d0d1021c-fe93-40a5-9367-1aef43656720)

***2. Install Oracle VM VirtualBox Manager***

- Download the compatible version from <a href="https://www.virtualbox.org/">VirtualBox</a>

***3. Install Windows 10***
- Navigate to <a href="https://www.microsoft.com/en-ca/software-download/windows10ISO">Microsoft</a> to install the compatible version.
   - Select the edition
   - Select the product language
   - Select 64-bit Download
   - Once the download pop up appears, select "Create installation media (USB flash drive, DVD, or ISO file) for another PC"
   - Select "ISO file" when pop up asks "Choose which media to use"
   - Save ISO file
- In VirtualBox, click "New" to create a new VM
   - Name: choose a name for VM (I named it Windows)

        Please note: this machine will be used as our target machine
   - Folder: select where you want VM to live
   - ISO Image: select ISO image that you just downloaded
   - Check "Skip Unattended Installation" to install OS manually

  ![Screen Shot 2025-02-04 at 5 15 38 PM](https://github.com/user-attachments/assets/d123ae11-c032-4ebc-baa8-40559718ec41)
  
  - Configure VM specifications (this can vary depending on your computer's specifications):
    - Select 4000 MB RAM for base memory, 1 CPU for processors, 50 GB for virtual hard disk
    - Finish
            
- Start VM and follow the installation prompts
   - Select "I don't have a product key"
   - Select "Windows 10 Pro"
   - Accept the license terms
   - Select "Custom: Install Windows only (advanced)"
   - Select "Next" to allow Windows to install 
      
***4. Install Kali Linux***
- Download <a href="https://www.kali.org/">Kali Linux</a>
   - Select the Pre-Built Virtual Machine
   - Choose either 64-bit (preferred) or 32-bit depending on your machine
     - To verify your machines specifications, select Windows key > type "System" > select "System Information" > view "System Type"
   - Click 64-bit, then choose VirtualBox 64
- Extract Kali Linux
   If you have any trouble extracting Kali Linux, download <a href="https://www.7-zip.org/">7 Zip</a> and extract with this tool.
- Once extracted, double click on the "vbox" file so that it's automatically imported into VirtualBox

![Screen Shot 2025-02-04 at 5 40 31 PM 1](https://github.com/user-attachments/assets/589bad71-9034-4702-955e-f566caea0a4f)

- Now, go to VirtualBox and run the Kali VM by clicking "Start"
- Log in with default credentials: kali/kali

***5. Install Windows Server***
- Download <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2022">Windows Server 2022</a>
   - Fill out the form
   - Select "64-bit edition" under "ISO downloads"
- Once downloaded, go to VirtualBox and select "New" to create a new VM
   - Name: choose a name for VM (I named it ADDC since we will be using this as our Active Directory Domain Controller)
   - Folder: select where you want VM to live
   - ISO Image: select ISO image that you just downloaded
   - Check "Skip Unattended Installation" to install OS manually
- Configure VM specifications (this can vary depending on your computer's specifications):   
   - Select 4000 MB RAM for base memory, 1 CPU for processors, 50 GB for virtual hard disk
   - Finish
- Start VM and follow the installation prompts
   - Select "Install Now"
   - Select "Windows Server 2022 Standard Evaluation (Desktop Experience)"
   - Accept the license terms
   - Select "Custom: Install Windows Microsoft Server Operating System only (advanced)"
   - Select "Next" to allow Windows to install
   - Once setup is completed, you will be prompted to create a password
   - Select "Finish"
- Log in with recently created password
      - Select "No" when asked "Do you want to allow your PC to be discoverable by oth PCs and devices on this network?"


***6. Install Ubuntu Server***
- Download <a href="https://ubuntu.com/server">Ubuntu Server</a>
- Once downloaded, go to VirtualBox and select "New" to create a new VM
   - Name: choose a name for VM (I named it Splunk since we will be using this as our Splunk Server)
   - Folder: select where you want VM to live
   - ISO Image: select ISO image that you just downloaded
   - Check "Skip Unattended Installation" to install OS manually
- Configure VM specifications (this can vary depending on your computer's specifications):
       - Select 8000 MB RAM for base memory, 2 CPU for processors, 100 GB for virtual hard disk
          - Splunk will require more specs as it will be ingesting data and we'll be running searches on it  
- Finish
- Start the VM
   - Select "Try or Install Ubuntu Server"
   - Follow installation prompts; leave as default
   - Fill out "Profile Setup" form, which is where you will choose your credentials
    - Once installed, select "Reboot Now"
    - Click "Enter" when "Failed unmounting" error pops up
- Once rebooted, logon with recently created credentials
    - run command: sudo apt-get update && sudo apt-get upgrade -y
         - this command will update & upgrade all of our repositories
    - Once completed, hit "Enter" 

***Summary***

You should now have Oracle VM VirtualBox Manager installed, along with four VMs running Windows 10, Kali Linux, Windows Server, and Splunk Server.

![lab set up](https://github.com/user-attachments/assets/07ac8df9-b70f-4338-8727-55a09dd50412)


## Phase 2: Configure the Network

***1. Setup Communications***
- In Virtual Box, navigate to Tools > Network > NAT Networks > Create
   - Refer to screenshot below for configuration details.

![NAT](https://github.com/user-attachments/assets/6a33e514-410c-4b33-b234-18148c97bb0b)

   - Click "Apply"
   - Navigate to each VM > Settings > Network
   - Refer to screenshot below for configuration details.

![NAT config](https://github.com/user-attachments/assets/90bdf6cc-0d5e-4c84-90c3-9c53c53230e9)

- Repeat the above 2 steps for each VM
   - Navigate to each VM > Settings > Network
   - Refer to screenshot above for configuration details.    
- Next, start Splunk VM
   - run: ip a
      - this will display current IP address, which will need to be updated to static IP 192.168.10.10/24
- To set a static IP on Splunk server:
   - Run: sudo nano /etc/netplan/00-installer-config.yaml
      - tab to auto-complete, should only have one file 
   - Configure:
  ```
  network: 
     ethernet:
       enp0s3:
         dhcp4: no
         addresses: [192.168.10.10/24]
         nameservers:
               addresses: [8.8.8.8]
         routes:
          - to: default
            via: 192.168.10.1
   version: 2
    ```
   - Save configuration
   - Run: sudo netplan apply
   - Run: ip a
      - This will verify if IP address persists and is set to 192.168.10.10/24   
   - Reboot
   - Verify connection by running: ping google.com
     
The steps above did not work for me as I had a different configuration file, but this turned out to be a great opportunity to troubleshoot and learn more. The configuration file on my Splunk server was 50-cloud-init.yaml, meaning our IP updates wouldn’t persist after a reboot. To resolve this, I created a custom 00-installer-config.yaml file inside /etc/netplan/ and configured it with the updated IP. This ensured the static IP would remain after a reboot instead of reverting to DHCP. I also had to back up and delete the old 50-cloud-init.yaml file. Reboot and verify IP address once done.

***2. Install Splunk***
   
- Navigate to <a href="https://www.splunk.com/">Splunk</a> download free trial of Splunk Enterprise
   - Select Linux as OS
   - Select ".deb" file
   - Save into preferred directory
- Navigate back to Splunk VM
   - Run: sudo apt-get install virtualbox
      - this will display what options are available
   - Run: sudo apt-get install virtualbox-guest-additions-iso
   - Type "y"
   - Click "Enter"
   - Once installed, run: clear
- Navigate to Devices (on the top left of the screen) > Shared Folders > Shared Folders Settings
   - Add a folder
      - Folder Path: select path where we saved our Splunk installer
      - Foler Name: leave as default (AD-Project in our case)
      - Select: Read-only, Auto-mount, and Make Permenant
      - Click "Ok" 
- In Splunk, run: sudo reboot
   - Once rebooted, log back in
   - Run: sudo adduser <your username> vboxsf
      - ex. sudo adduser username vboxsf
   - If you receive a "group vboxsf does not exist" error, we may need some additional guest installations
      - Run: sudo apt-get install virtualbox
         - This will display what options are available
      - Run: sudo apt-get install virtualbox-guest-utils
      - Run: sudo reboot
      - Run: sudo adduser username vboxsf
         - User should be added to group now
- Create a new directory called "Share"
   - Run: mkdir Share
   - Run: ls
      - Newly created directory "Share" should be listed 
- Next, mount our shared folder onto our directory called "Share"
   - Run: sudo mount -t vboxsf -o uid=1000,gid=1000 <directory name where .deb file is located> share/
      - ex. sudo mount -t vboxsf -o uid=1000,gid=1000 AD-Project share/
      - If you forget what your shared folder name is:
         - Navigate to Devices > Shared Folders > Shared Folders Settings
   - If you get an error, exit session and re-do steps
      - Run: exit
      - Error may occur because when you add your user into a new group, it may not reflect until you log out
   - Run: ls -la
      - Should now see that our "share" is now highlighted
- Change directories into that share
   - Run: cd share
   - Run: clear
   - Run: ls -la
      - This will display all the files listed in this directory, including our Splunk Installer
- To install Splunk:
   - Run: sudo dpkg -i splunk (hit tab to auto-complete)
   - Once you see "Complete", should be good to change into directory where Splunk is located onto our server
- Change directory
   - Run: cd /opt/splunk
   - Run: ls -la
      - Here you will notice that all users and groups belong to Splunk, which is a good thing as it limits the permissions to that user
- Change into user Splunk
   - Run: sudo -u splunk bash
      - Now, we are acting as user Splunk 
- Run: cd bin
   - Files listed in here are all binaries that Splunk can use
   - the one that we will use is "./splunk start"
   - Run: ./splunk start
      - This will run the installer
   - Click "q"
   - Type "y" to accept
   - Select an administrator username and password
- Once installation is completed:
   - Run: exit
      - To exit out of user Splunk 
   - Run: cd bin
   - Run: sudo ./splunk enable boot-start -user splunk
      - Whenever the VM reboots, Splunk will run with user splunk

![splnk login](https://github.com/user-attachments/assets/647ecc3c-8549-4d9b-ac4f-1ec626b56d54)
  
***3. Configure Windows Machine***

Please note that configuring the Windows Machine and the Windows Server is extremely similar. The main difference is that the Windows Machine will be renamed to "target-PC", meanwhile the Windows Server will be renamed to "ADDC01". Additionally, the Windows Machine's static IP address will be updated to 192.168.10.100, and the Windows Server's static IP will be updated to 192.168.10.7.
   
- Rename the host name of machine
   - In the Start Menu search, search "PC"
   - Select "Properties"
   - Select "Rename this PC"
   - Rename to "target-PC"
   - Select "Next"
   - Select "Restart Now"
     
- Update static IP to 192.168.10.100
   - Open command prompt
   - Run: ipconfig
      - this will display current IPv4
   - Navigate to network icon at the bottom right of the window
   - Select "Open Network & Internet Settings"
   - Select "Change adapter options"
   - Right click the adapter, Ethernet
   - Select "Properties"
   - Select "Internet Protocol Version 4 (TCP/IPv4)" > "Properties"
   - Select "Use the following IP address"
   - Configure as shown below:
     
![windows 8 8 8 8](https://github.com/user-attachments/assets/84f4a826-b0e2-46d8-b099-59dac9e59256)


   - Run ipconfig to view updated IPv4

![cmnd prompt](https://github.com/user-attachments/assets/38e0c671-84ff-4246-b9e3-f668b4fc1809)

- Install Splunk Universal Forwarder on target-PC (Please note: installing Splunk Universal Forwarder and Sysmon on the ADDC VM will follow these exact same steps)
   - Run Splunk VM (the following steps will not work if VM is not running)
   - In the target-PC, open the browser and type 192.168.10.10:8000
      - Splunk listens on port 8000 
   - In the target-PC, visit <a href="https://www.splunk.com/">Splunk</a>
      - Create an account
      - Select "Products"
      - Select "Free Trials & Downloads"
      -  Scroll down to Universal Forwarder & select "Get My Free Download"
      -  Select the compatible OS
   - Once download is completed, double click the msi file
      - Select "Check this box to accept the License Agreemnent"
      - Select "An on-premises Splunk Enterprise Instance"
      - Select "Next"
      - Choose your credentials
      - For "Receiving Indexer", this is going to be our Splunk Server's IP address
         - Hostname or IP: 192.168.10.10
         - Default port for Splunk when receiving events is: 9997
      - Select "Next"
      - Select "Install"
   - UniversalForwarder Setup pop up will flash orange
      - Select "Finish"  

- Install Sysmon
   - In the target-PC, navigate to <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon">Sysmon Downloads</a>
      - Select "Download Sysmon" 
   - Navigate to <a href="https://github.com/olafhartong/sysmon-modular/blob/master/sysmonconfig.xml">Sysmon's Configuration File</a> on GitHub
      - This is the sysmon configuration that we will be using
   - Select "Raw"
     
![sysmon git](https://github.com/user-attachments/assets/b9d900d1-ad9a-4a4e-8e64-83191e12ee15)

   - Save in downloads 
   - Extract the Sysmon file
      - Navigate to downloads directory
      - Right click "Sysmon"
      - Select "Extract All"
      - Select "Extract"
   - Copy the file path
     
![copy file path](https://github.com/user-attachments/assets/0c4718e4-afbc-4962-95b7-ac663126f357)
        
   - Open PowerShell as administrator
   - Change directory into the file path 
      - Run: cd (Paste the file path of the extracted directory here)
      - ex. cd C:\Users\hacki\Downloads\Sysmon 
   - Run: .\Sysmon64.exe -i ..\sysmonconfig.xml
      - -i flag indicates that we want to specify a configuration file
      - ../ allows us to go back one directory 
         - sysmon config file is locaed under downloads directory so ../ will allow us to do that
   - Hit "Enter"
   - Select "Agree" to install Sysmon
   - Screen will display "Sysmon64 started"
   - Close PowerShell
 

- Configure Splunk Unviersal Forwarder to specify what data we want to send to our Splunk Server
   - Do this by configuring file called "inputs.conf"
   - Navigate to File Explorer > Local Disk (C:) > Program Files > SplunkUniversalForwarder > etc > system > default > inputs.conf
      - Do NOT want to edit the inputs.conf file under the default directory
   - Create a new file under the local directory and name it inputs.conf
      - Open Notepad as administrator and enter the below information:
         - This instructs Splunk Universal Forwarder to push events related to Application, Security, System, and Sysmon over to Splunk Server
         - Take note of "index=endpoint", whatever falls under these categories will be sent over Splunk and placed under the index "endpoint". If our Splunk Server does not have an index named endpoint, it will not receive any of these events. 


```
[WinEventLog://Application]
index = endpoint
disabled = false

[WinEventLog://Security]
index = endpoint
disabled = false

[WinEventLog://System]
index = endpoint
disabled = false

[WinEventLog://Microsoft-Windows-Sysmon/Operational]
index = endpoint
disabled = false
renderXml = true
source = XmlWinEventLog:Microsoft-Windows-Sysmon/Operational

```
   - Save file 
      - Save under local directory
         - File Explorer > Local Disk (C:) > Program Files > SplunkUniversalForwarder > etc > system > local > inputs.conf
      - File Name: inputs.conf
      - Save as type; All Files
      - Save
   - Restart
      - Any time you update "inputs.conf" file, you must restart Splunk's Universal Forwarder service
      - Open "Services" as administrator
      - Find "SplunkForwarder"
         - Double click "SplunkForwarder"
         - Select "Log On"
         - Select "Local System Account"
         - Select "Apply"
         - Select "Ok"
      - Right click "SplunkForwarder" and select "Restart" or click "Restart" on the top left
        
![restart splunkfwd](https://github.com/user-attachments/assets/28038e71-6b06-46e3-a8ad-ffa6895d9bca)

   - Select "Start" the service
     
Now, we have our Sysmon & Splunk Universal Forwarder installed along with our updated inputs.conf file.

- Finalize Splunk Server configuration
   - On the target-PC, go to Splunk web portal
      - Search 192.168.10.10:8000 in browser
         - Splunk VM must be running in order for portal to work
      - Log on with credentials created during Splunk install on Splunk Server
   - Once logged on, create "endpoint" index
      - Select "Settings"
      - Select "Indexes"
      - Select "New Index"
      - Index Name: endpoint
      - Select "Save"
        
![new index](https://github.com/user-attachments/assets/ea3654cd-9bd3-4cfe-9b00-d872b1b5ae22)

   - Next, enable Splunk Server to receive data
      - Select "Settings"
      - Select "Forwarding and receiving"
      - Under "Receive data", select "Configure receiving"
      - Select "New Receiving Port"
      - Listen on this port: 9997 
         - If you recall during the set up, 9997 is the default port
      - Select "Save"
   - Should now see data coming in from target-PC 
      - Select "Search & Reporting"
      - Search "index=endpoint"
      - Scroll down to "host" and you will see 1 host, which is the target-PC
         - Once Windows Server is configured, you will see 1 host  

![1 host](https://github.com/user-attachments/assets/d8689fc6-1742-411c-9bf5-63a065210471)


***5. Configure Windows Server***

- Rename the host name of machine
   - In the Start Menu search, search "PC"
   - Select "Properties"
   - Select "Rename this PC"
   - Rename to "ADDC01"
   - Select "Next"
   - Select "Restart Now"
     
- Update static IP to 192.168.10.7
   - Open command prompt
   - Run: ipconfig
      - this will display current IPv4
   - Navigate to network icon at the bottom right of the window
   - Select "Open Network & Internet Settings"
   - Select "Change adapter options"
   - Right click the adapter, Ethernet
   - Select "Properties"
   - Select "Internet Protocol Version 4 (TCP/IPv4)" > "Properties"
   - Select "Use the following IP address"
   - Configure as shown below:
     
![addc ip](https://github.com/user-attachments/assets/c7dc690f-405f-4408-912b-d1d686efe638)

   - Run ipconfig to view updated IPv4

![addc static](https://github.com/user-attachments/assets/29b3e82b-bcdb-4826-b59c-b8793a461d57)

- Install Splunk Universal Forwarder on target-PC (Please note: installing Splunk Universal Forwarder and Sysmon on the ADDC VM will follow these exact same steps)
   - Run Splunk VM (the following steps will not work if VM is not running)
   - In the target-PC, open the browser and type 192.168.10.10:8000
      - Splunk listens on port 8000 
   - In the target-PC, visit <a href="https://www.splunk.com/">Splunk</a>
      - Log on to account
      - Select "Products"
      - Select "Free Trials & Downloads"
      -  Scroll down to Universal Forwarder & select "Get My Free Download"
      -  Select the compatible OS
   - Once download is completed, double click the msi file
      - Select "Check this box to accept the License Agreemnent"
      - Select "An on-premises Splunk Enterprise Instance"
      - Select "Next"
      - Choose your credentials
      - For "Receiving Indexer", this is going to be our Splunk Server's IP address
         - Hostname or IP: 192.168.10.7
         - Default port for Splunk when receiving events is: 9997
      - Select "Next"
      - Select "Install"
   - UniversalForwarder Setup pop up will flash orange
      - Select "Finish"  

- Install Sysmon
   - In the ADDC01 machine, navigate to <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon">Sysmon Downloads</a>
      - Select "Download Sysmon" 
   - Navigate to <a href="https://github.com/olafhartong/sysmon-modular/blob/master/sysmonconfig.xml">Sysmon's Configuration File</a> on GitHub
      - This is the sysmon configuration that we will be using
   - Select "Raw"
     
![sysmon git](https://github.com/user-attachments/assets/b9d900d1-ad9a-4a4e-8e64-83191e12ee15)

   - Save in downloads 
   - Extract the Sysmon file
      - Navigate to downloads directory
      - Right click "Sysmon"
      - Select "Extract All"
      - Select "Extract"
   - Copy the file path
     
![copy file path](https://github.com/user-attachments/assets/0c4718e4-afbc-4962-95b7-ac663126f357)
        
   - Open PowerShell as administrator
   - Change directory into the file path 
      - Run: cd (Paste the file path of the extracted directory here)
      - ex. cd C:\Users\hacki\Downloads\Sysmon 
   - Run: .\Sysmon64.exe -i ..\sysmonconfig.xml
      - -i flag indicates that we want to specify a configuration file
      - ../ allows us to go back one directory 
         - sysmon config file is locaed under downloads directory so ../ will allow us to do that
   - Hit "Enter"
   - Select "Agree" to install Sysmon
   - Screen will display "Sysmon64 started"
   - Close PowerShell
 

- Configure Splunk Unviersal Forwarder to specify what data we want to send to our Splunk Server
   - Do this by configuring file called "inputs.conf"
   - Navigate to File Explorer > Local Disk (C:) > Program Files > SplunkUniversalForwarder > etc > system > default > inputs.conf
      - Do NOT want to edit the inputs.conf file under the default directory
   - Create a new file under the local directory and name it inputs.conf
      - Open Notepad as administrator and enter the below information:
         - This instructs Splunk Universal Forwarder to push events related to Application, Security, System, and Sysmon over to Splunk Server
         - Take note of "index=endpoint", whatever falls under these categories will be sent over Splunk and placed under the index "endpoint". If our Splunk Server does not have an index named endpoint, it will not receive any of these events. 


```
[WinEventLog://Application]
index = endpoint
disabled = false

[WinEventLog://Security]
index = endpoint
disabled = false

[WinEventLog://System]
index = endpoint
disabled = false

[WinEventLog://Microsoft-Windows-Sysmon/Operational]
index = endpoint
disabled = false
renderXml = true
source = XmlWinEventLog:Microsoft-Windows-Sysmon/Operational

```
   - Save file 
      - Save under local directory
         - File Explorer > Local Disk (C:) > Program Files > SplunkUniversalForwarder > etc > system > local > inputs.conf
      - File Name: inputs.conf
      - Save as type; All Files
      - Save
   - Restart
      - Any time you update "inputs.conf" file, you must restart Splunk's Universal Forwarder service
      - Open "Services" as administrator
      - Find "SplunkForwarder"
         - Double click "SplunkForwarder"
         - Select "Log On"
         - Select "Local System Account"
         - Select "Apply"
         - Select "Ok"
      - Right click "SplunkForwarder" and select "Restart" or click "Restart" on the top left

![restart splunkfwd](https://github.com/user-attachments/assets/59ca3d70-f3e7-4d99-9734-8054a10d038c

   - Select "Start" the service
     
Now, we have our Sysmon & Splunk Universal Forwarder installed along with our updated inputs.conf file.

   - Now, we should see data coming in from ADDC01 as well as the target-PC
      - Log onto Splunk web portal by searching 192.168.10.10:8000 in browser
         - Splunk VM must be running in order for portal to work
      - Log on with credentials created during Splunk install on Splunk Server
      - Select "Search & Reporting"
      - Search "index=endpoint"
      - Scroll down to "host" and you will see 2 hosts
        
![2 hostss](https://github.com/user-attachments/assets/8841c579-4b50-4e38-9e3f-3e1ab3959560)

***Summary***

We have successfully installed Sysmon and Splunk on both our Windows machine (target-PC) and Windows Server (ADDC01). Now, when logged into the Splunk Server on either machine, you should be able to view the telemetry from both machines. 

![Splunk hosts](https://github.com/user-attachments/assets/e51494bd-bfea-47c8-9f24-3bbf92377e75)


## Phase 3: Active Directory and Control Domain

***1. Setup Active Directory Domain Services on Windows Server***

- Install ADDS aka Active Directory Domain Services
   - On Windows Server, open "Server Manager"
   - Select "Manage" > Add Roles & Features > Next > Role-based of feature-based installation > Next > select ADDC01 > Next > select "Active Directory Domain      Services > Add features > Next > Next > Install
   - Once installed, select "close"
     
- Promote the server & create a new domain
   - Open Server Manager 
   - Select the flag icon
   - Select “Promote the server to a domain controller"
   - Select “Add a new forest” since we are creating a new domain
      - Root domain name: yourdomainname.local
         - Domain name must have top level domain; cannot just be "yourdomainname"
            - ex. hackingprincesa.local, hackingprincesa.test, yourdomainname.test, etc 
         - Attackers love to attack domain controllers since it has access to everything. Access to this file grants access to everything related to AD                  including passwords hashes.
         - Create a password
         - Install
         - Machine will automatically restart
- Log in
   - On logon screen, will see domainame\Administrator
      - This indicates that we have successfully installed ADDS and promoted our server to a domain controller.
                     
- Create users
   - Open Server Manager
   - Select "Tools"
   - Select "Active Directory Users and Computers"
      - Here we can create objects such as users, computers, groups, etc.
   - Add a new OU aka Organizational Unit
      - Please note: OUs can be used to group objects by function, location, department, or other criteria. In a work environment, OUs are usually used as            departments.
      - Right click the domain > select "New" > Organizational Unit
      - Name: "IT"
        
![OU](https://github.com/user-attachments/assets/c19d9665-75c0-4905-9b47-db82e97e424e)

   - Within this new OU, create a new user
      - Select "New" > "User"
![ner user](https://github.com/user-attachments/assets/603d8586-e089-4e62-8e3c-38bd34031275)

      - Fill out the form with new user information to successfully add a new user.
      
![new user in IT](https://github.com/user-attachments/assets/cdd721ba-ef01-4208-8829-3a32f06268fb)

Active Directory is now set up and our server is now promoted to domain controller.

              
***2. Configure Windows 10 Machine to Join New Domain***

- Log onto Windows 10 machine and join our newly created domain & authenticate using Jenny Smith account
   - Log onto Windows 10 machine (target-PC) 
   - Search PC > select "Properties" > Advanced system settings > Computer Name > Change
   - Under "Member of", select "Domain"
     
![member of domain](https://github.com/user-attachments/assets/472f64e4-b870-4b27-8308-0852db7e995c)

   - You will get an error message; this is related to the DNS we configured earlier. Originally, we had our Preferred DNS server set to 8.8.8.8, which is         Google's DNS server. We want to update the Preferred DNS server so that it is pointing to our domain controller, which is 192.168.10.7.
      - Update the Preferred DNS Server to the domain controller's IP address:
         - Navigate to network icon at the bottom right of the window
         - Select "Open Network & Internet Settings"
         - Select "Change adapter options"
         - Right click the adapter, Ethernet
         - Select "Properties"
         - Select "Internet Protocol Version 4 (TCP/IPv4)" > "Properties"
         - Select "Use the following IP address"
         - Configure as shown below:

![windows static IP](https://github.com/user-attachments/assets/f27e01d7-6811-4b93-8f19-13cf91856222)

   - Confirm updated DNS Server in Command Prompt
      - Open Command Prompt
      - Run: ipconfig /all

![cmnd prompt - dns conf](https://github.com/user-attachments/assets/28405fc6-bafb-4007-b7d2-cc7bea5d43e1)

   - Now, we can join the domain
      - Search PC > select "Properties" > Advanced system settings > Computer Name > Change
      - Under "Member of", select "Domain"
![member of domain](https://github.com/user-attachments/assets/472f64e4-b870-4b27-8308-0852db7e995c)

      - Select "Ok"
      - Will be prompted to enter credentials
         - User the administrator account of the server to log on as it has the appropiate permissions
            - The administrator account will grant access to join domain 
           
![admin cred](https://github.com/user-attachments/assets/20293e09-eb06-49a5-9b69-d70349d26861)

   - You will get a pop up welcoming you to the domain.
   - Computer will prompt you to restart
     
- Once you are back on the log on screen, confirm that new user has successfully joined the domain
   - Select "Other User"
   - Log on with your newly created user Jenny Smith or Maria Rodriguez
   - Type "jsmith" and the password

![jsmith log on](https://github.com/user-attachments/assets/bdba0549-81dd-4708-ae98-06bf6fe3b292)


***Summary***

We have successfully configured our Active Directory server, created new users, joined our computer to a new domain, and logged in as a domain user.

![welcome jenny](https://github.com/user-attachments/assets/d731160b-07b3-43b6-ad1c-751e7a178469)


## Phase 4: Brute Force Attack

***1. Configure Network***

- Log onto Kali Linux machine with default credentials
- Configure a static IP address to 192.168.10.250
   - Right click the Ethernet icon
   - Select "Edit Connections"
     
![edit connection](https://github.com/user-attachments/assets/2570ea72-9b77-4d14-9b90-399d4dc70ef9)

   - Select Wired connection 1
   - Select the cog icon
   - Select IPv4 Seetings
   - Configure and save:

![kali static ip](https://github.com/user-attachments/assets/8dff6f03-48ba-41cc-b28a-879cf7d3760d)

   - To reflect changes, select the Ethernet icon and select "Disconnect
   - Select the Ethernet icon again and select "Wired connection 1"
   - Confirm that the static IP has been updated
      - Open terminal
      - Run: ip ab
        
![kali terminal](https://github.com/user-attachments/assets/346e6ff5-1e7b-494c-a017-2eb9589f2753)

   - Verify connectivity
      - Run: ping google.com
      - Run: ping 192.168.10.10
        
- Update & upgrade repositories
   - Run: sudo apt-get update && sudo apt-get upgrade -y
     
- Set up attack, once update & upgrade is complete
   - First, create a new directory called AD Project
      - Run: mkdir AD-Project
      - This will create a directory on our desktop. All the files that we will create & use, will be put into this directory.

- Install crowbar
   - Run:sudo apt-get install -y crowbar
   - Crowbar is the tool that we will be using to perform brute force attacks. We can target either our ADDC machine or our target machine.
   - Please note: We are using this tool for educational purposes only; please only attack consenting targets.

- Use rockyou f
	- Rockyou is a popular world list that comes with Kali Linux
- Change to the directory where you will find rockyou file  
	- Run: cd /usr/share/wordlists/
	- Run: ls
- Unzip rockyou.txt.gz file using gunzip
	- Run: sudo gunzip rockyou.txt.gz
 	- Run: ls
 Now, you should see rockyou.txt:

![find rockyou](https://github.com/user-attachments/assets/269ba022-6bc5-44ce-93ab-0fccf00d2887)

- Copy this file onto AD Project folder
	- Run: cp rockyou.txt ~/Desktop/AD-Project/
- Change into AD Project directory
	- cd ~/Desktop/AD-Project/
- Verify that it rockyou.txt copied over into this directory
	- Run: clear 
 	- Run: ls -lh

Here, you can see that this file contains 134 M meaning it contains quite a bit of passwords. For the sake of the project, we will only use the first 20 lines. 

![rockyou](https://github.com/user-attachments/assets/17bf1e10-4e21-41b0-85b3-b73b3584de63)

- To only use the first 20 lines:
	- Run: head -n 20 rockyou.txt
   
Here, you will see 20 lines.

![rockyou 20](https://github.com/user-attachments/assets/7380ef1a-0730-432a-92bd-1276d5fd979b)

- Clear it out
	- Run: clear 
- Output it to a file called passwords.txt
	- Run: head -n 20 rockyou.txt > passwords.txt
 	- Run: ls
  		- Now, you will see the rockyou.txt & the passwords.txt file
      
![kali - pw   ru file](https://github.com/user-attachments/assets/3f70cdc7-d74c-4454-bbff-971d29bf38e0)

- Open passwords.txt
	- Run: cat passwords.txt
 		-  Should see the 20 lines
     
![kali pw](https://github.com/user-attachments/assets/70141978-c3c0-4255-84dd-dfc3875c48bc)

- Let’s say we want to target a certain PW
	- Run: nano passwords.txt
 		- This command allows you to edit the file
   		- Add PW at end
     		- Save by holding control + x
       		- Type "Y"
         	- Enter
            
![kali PW file edit](https://github.com/user-attachments/assets/5ae3e437-f6bc-4be6-b664-63066a1caf54)

- Verify that edit was saved
	- Run: cat passwords.txt
 	- Should see 21 lines
    
![cd pw file](https://github.com/user-attachments/assets/5df58b44-f3cc-4a49-ac96-65d25566a80f)

- Before we launch the attack, we want to enable Remote Desktop Protocol aka RDP
	- Open Windows target-PC
 	- Enable remote desktop on target-PC
  	- Go to the PC’s properties
  		- Search PC
  	 	- Select Properties  
  	- Select Advanced system settings
  		- Will prompt you to logon with administrator credentials
  	- Select Remote tab
  	- Select Allow remote connections to this computer
  	  
![allow RDP](https://github.com/user-attachments/assets/4c97d85e-6d9e-4684-845c-4f0d8b70bca7)
  	- Select Select Users…
  	- Select Add
  	- Add your users
  		- Type "jsmith" for Jenny Smith, then select "Check Names"
  	 	- Type "tsmith" for Terry Smith, then select "Check Names"
  	- Select OK
  		- Here you will see both users added
  	     
![RDP](https://github.com/user-attachments/assets/616ed192-c66c-43d0-a56b-334c2165088d)
  	- Select OK
  	- Select Apply
  	- Select OK
   
- We have successfully enabled remote desktop onto target-PC.
	- You can also enable RDP on your ADDC machine if you'd like. 
  
- Open Kali Linux machine
- Open terminal
- Open crowbar's, the brute force tool, help menu
	- Run: crowbar -h
 	- This command allows us to see what options are available. The service that we are interested in is RDP; hence, why we are using this tool & why we 	enabled RDP.

![crowbar -hh](https://github.com/user-attachments/assets/584e9efa-afc1-404c-8cc2-fca84056b0c3)

- Attack
	- Run: crowbar -b rdp -u tmsith -C passwords.txt -s 192.168.10.100/32
 		- b specifies service (rdp)
  		- u specifies account of interest (tsmith)
   		- C specify a PW list (passwords.txt)
   		- s to specify source IP (target machine’s IP)
     			- must specify a cider notation 
   			- use /32 instead of /24 because I want to only target this one IP
        
Once we execute crowbar, it will start trying out all of the password's that are listed under the password.txt file 
        
![crowbar](https://github.com/user-attachments/assets/e479b094-41ab-4aa2-9ce4-08dc054ca656)

- View telemetry generared on Splunk
	- Open Splunk
		- Search "192.168.10.10:8000" in browser
  	- Select Search & Reporting
  	- Narrow down search 
  		- Search "index=endpoint tsmith"
  	 - Select EventCode under "Interesting Fields"
  	 	- Here, you will see a total count of 78 for event code 4625
     google event id’s you don’t know ex. 4625 is an account failed to log on
Select 4625, it will update in search bar
Look at the time of all events, will see that they all happened around the same time, which is a clear indicator of a brute force attack
Search with eventcode=4624 and you will see a 
4624: An account was successfully logged on 
Click Show all 70 lines to investigate
You will see workstation and IP that performed brute force
Install Atomic Red Team (ART)
Open Powershell as admin
Run: Set-ExecutionPolicy Bypass CurrentUser
 Y
Now, you want to install ART framework, but first set an exclusion for the entire c drive as microsoft defender will detect & remove some of the files from ART
Select on up arrow on Windows 
Select Windows Security icon
Select Virus & threat protection
Select Manage settings
Select “Add or remove exclusions”
Select Add an exclusion
Select folder
Select This PC
Select our C drive
Select “Select Folder”
You should see the exclusion for the c drive
    img
Download ART zips onto Windows target-PC
Create a new folder in C drive
    Name it Atomic Red Team
Move zip files to the ART folder
Extract files
Once extracted, can delete the zips
Clean up files 
there’s a duplicate directory, make sure to move appropriate files to one directory and delete the duplicate
Next, delete “master” out of file name “invoke-atomicredteam-master”
    invoke-atomicredteam
Select atomic-red-team-master
    Move atomics file to Atomic Red Team folder that we created
    img
Set up powershell
<Going to follow invoke-atomicredteam’s link regarding installation
Powershell can’t run scripts so run command 
Set-ExecutionPolicy Bypass CurrentUser or powershell -exec bypass
      Y
Install nodule
Copy script from github
Import module
    copy script from github
Now you will use one of the tactics from the atomics folder
Choose which tactic you want to use
Run: Invoke-AtomicTest T1136.001
        This attack created a new windows admin user called “newlocaluser”
This will generate telemetry
- Search in Splunk
	- index=endpoint NewLocalUser
 	- If no events, that will tell you that you’re blind to this activity. If an attacker compromised system and created a local account with your current settings, you will not be able to detect activity. Hence why ATR is good for SOC as it identifies the gaps and visibility for you and will also generate the telemetry to see if you can actually detect that activity
- Perform another attack
	Invoke-AtomicTest T1059.001
        This attack is called Command and Scripting Interpreter using Powershell
- Search in Splunk
	- Type "index=endpoint powershell" in search bar
<Can build alerts to detect both attacks in the future
  

   
***2. Set up the Attack***
   
***3. Enable RDP***
   
***4. Attack***
   
***5. ART***

## Phase 5: Splunk Telemetry

1. Analyze Attack with Splunk

## References & Resources:
- <a href="https://www.youtube.com/watch?v=mWqYyl89QaY&t=541s">Active Directory Project by MyDFIR</a>
- Microsoft Active Directory Documentation
- Splunk Documentation
- <a href="https://github.com/redcanaryco/atomic-red-team">Atomic Red Team GitHub</a>
- Sysmon Documentation
- Splunk Universal Forwarder Documentation
